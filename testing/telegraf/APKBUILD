# Contributor: Charles Durieux <durieux.charles01@gmail.com>
# Maintainer:
pkgname="telegraf"
pkgver="1.6.3"
pkgrel="0"
pkgdesc="The plugin-driven server agent for collecting & reporting metrics."
url="https://github.com/influxdata/telegraf"
arch="all"
license="MIT"
depends=""
makedepends="go"
install="$pkgname.pre-install"
subpackages=""
source="
	${pkgname}-${pkgver}.tar.gz::https://github.com/influxdata/${pkgname}/archive/${pkgver}.tar.gz
	telegraf.initd
	telegraf.confd
	telegraf.pre-install
	"

export GOPATH="$startdir"
export PATH="$PATH:$GOPATH/bin"

basebuilddir="$GOPATH/src/github.com/influxdata"
builddir="$basebuilddir/$pkgname"

unpack() {
	mkdir -p "$basebuilddir"
	cd "$basebuilddir"
	tar -C "$basebuilddir" -zxf "${srcdir}/${pkgname}-${pkgver}.tar.gz"
	mv "${pkgname}-${pkgver}" "$pkgname"
}

prepare() {
	get_go_deps
	default_prepare
}

get_go_deps() {
	cd "$builddir"
	
	echo ">>> fetching Go Dependency Manager"
	go get -u github.com/golang/lint/golint
	go get github.com/sparrc/gdm

	echo ">>> fetching Go dependencies"
	gdm get --parallel=false
}

build() {
	cd "$builddir"
	go build -i -v -work -x -o "$pkgname" \
		cmd/telegraf/telegraf.go
}

check() {
	cd "$builddir"
	go test -short ./...
}

package() {
	cd "$builddir"

	install -m755 -D "$srcdir"/"$pkgname".initd \
		"$pkgdir"/etc/init.d/"$pkgname"

	install -m644 -D "$srcdir"/"$pkgname".confd \
		"$pkgdir"/etc/conf.d/"$pkgname"
	install -m755 -d "$pkgdir"/etc/"$pkgname"/"$pkgname".d
	install -m644 -D "$builddir"/etc/logrotate.d/"$pkgname" \
		"$pkgdir"/etc/logrotate.d/"$pkgname"
	
	install -m755 -D "$builddir"/"$pkgname" \
		"$pkgdir"/usr/bin/"$pkgname"
	
	# we get rid of /bin cause we cant override the cleanup
	rm -rf "$startdir/bin"
}

sha512sums="5a52aa459bfc1723a6117bfa1d696f047300c689fa35894ccb91e4d43d8e9d205e192bc8010d57a9a665899fb3f54721bc9c1095df44315eb3041679e22ee5ac  telegraf-1.6.3.tar.gz
968c9a15c62d1c97d97c10162b847725bc55355d35443c38694df35ab31e69e5efdabb0b94f5d598903609d393145adc46c58e3e47572e4f3a9094174a498c21  telegraf.initd
d8cabcc5c94d0655be23d50ba6d6406563c0687142cb2f7b6ea1c64223654cd6e7e57799fa671dd44e348d001804818335dba9463827299f7b4ca3d7876fa846  telegraf.confd
d4c1fa54ba1e5c88ff65b5223cc45dcc26c47a784bdc49140f71722c753fb1ac185e2d093dfabbb3d3e27f09ccbb9fbb4b5910c69656cb921f2391445590ca47  telegraf.pre-install"
